<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ontology Updater</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
<style>
/* â”€â”€ Reset & vars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #0a0c10;
  --panel:    #111318;
  --border:   #1e2230;
  --border2:  #2a3048;
  --green:    #4fffb0;
  --blue:     #4db8ff;
  --amber:    #ffb74d;
  --red:      #ff5f5f;
  --text:     #dde3f0;
  --muted:    #5a6380;
  --r:        12px;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 48px 16px 80px;
}

/* grid backdrop */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(79,255,176,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(79,255,176,.025) 1px, transparent 1px);
  background-size: 48px 48px;
  pointer-events: none;
}

.page { position: relative; z-index: 1; width: 100%; max-width: 800px; }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header { text-align: center; margin-bottom: 56px; }

.wordmark {
  display: inline-flex; align-items: center; gap: 12px;
  margin-bottom: 20px;
}

.wordmark-icon {
  width: 42px; height: 42px;
  background: var(--green);
  border-radius: 10px;
  display: grid; place-items: center;
  box-shadow: 0 0 24px rgba(79,255,176,.3);
}
.wordmark-icon svg { width: 22px; height: 22px; }

.wordmark-text {
  font-family: 'Space Mono', monospace;
  font-size: 1rem; font-weight: 700;
  letter-spacing: -0.3px;
}

h1 {
  font-size: clamp(1.8rem, 5vw, 2.6rem);
  font-weight: 800; line-height: 1.15;
  letter-spacing: -0.5px;
  background: linear-gradient(135deg, var(--text) 0%, #8899cc 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.tagline {
  color: var(--muted); font-size: 1rem; margin-top: 10px; line-height: 1.6;
}

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 28px 28px 32px;
  margin-bottom: 16px;
}

.card-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.68rem; letter-spacing: 1.8px; text-transform: uppercase;
  color: var(--green);
  display: flex; align-items: center; gap: 7px;
  margin-bottom: 22px;
}
.card-label::before {
  content: '';
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  flex-shrink: 0;
}

/* â”€â”€ File drop zones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
@media (max-width: 500px) { .drop-grid { grid-template-columns: 1fr; } }

.drop {
  position: relative;
  border: 1.5px dashed var(--border2);
  border-radius: 10px;
  padding: 32px 16px 26px;
  text-align: center;
  cursor: pointer;
  transition: border-color .2s, background .2s;
  overflow: hidden;
}
.drop input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.drop:hover, .drop.over { border-color: var(--green); background: rgba(79,255,176,.04); }
.drop.filled { border-style: solid; border-color: var(--green); background: rgba(79,255,176,.06); }

.drop-emoji { font-size: 2rem; display: block; margin-bottom: 10px; pointer-events: none; }

.drop-title {
  font-family: 'Space Mono', monospace;
  font-size: 0.72rem; letter-spacing: 1px; text-transform: uppercase;
  color: var(--muted); pointer-events: none;
}
.drop-sub {
  font-size: 0.7rem; color: var(--muted); opacity: .6;
  margin-top: 4px; pointer-events: none;
}
.drop-filename {
  font-family: 'Space Mono', monospace;
  font-size: 0.72rem; color: var(--green);
  margin-top: 9px; word-break: break-all;
  pointer-events: none;
  max-width: 180px; margin-inline: auto;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* â”€â”€ Toggle option â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.option-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 10px;
}
.option-row:last-child { margin-bottom: 0; }

.option-info { flex: 1; }
.option-name { font-size: .9rem; font-weight: 600; }
.option-desc { font-size: .78rem; color: var(--muted); margin-top: 3px; line-height: 1.4; }

.switch { flex-shrink: 0; margin-left: 20px; }
.switch input { display: none; }
.switch-track {
  display: block; width: 44px; height: 24px;
  background: var(--border2); border-radius: 24px;
  position: relative; cursor: pointer;
  transition: background .2s;
}
.switch-track::after {
  content: ''; position: absolute;
  width: 18px; height: 18px;
  background: white; border-radius: 50%;
  top: 3px; left: 3px;
  transition: transform .2s;
  box-shadow: 0 1px 4px rgba(0,0,0,.4);
}
.switch input:checked + .switch-track { background: var(--green); }
.switch input:checked + .switch-track::after { transform: translateX(20px); }

/* â”€â”€ Run button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.run-btn {
  width: 100%; padding: 18px;
  background: var(--green); color: #0a0c10;
  border: none; border-radius: var(--r);
  font-family: 'Space Mono', monospace;
  font-size: .9rem; font-weight: 700;
  letter-spacing: 1.2px; text-transform: uppercase;
  cursor: pointer;
  transition: transform .15s, box-shadow .15s, opacity .15s;
  position: relative; overflow: hidden;
}
.run-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(79,255,176,.28);
}
.run-btn:active:not(:disabled) { transform: translateY(0); }
.run-btn:disabled { opacity: .35; cursor: not-allowed; }
.run-btn.busy { color: transparent; }
.run-btn.busy::after {
  content: '';
  position: absolute; width: 20px; height: 20px;
  border: 2px solid rgba(0,0,0,.2);
  border-top-color: #0a0c10;
  border-radius: 50%;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: translate(-50%,-50%) rotate(360deg); } }

/* â”€â”€ Log terminal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#log-card { display: none; }
#log-card.show { display: block; }

.terminal {
  background: #060709;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  font-family: 'Space Mono', monospace;
  font-size: .75rem;
  line-height: 1.7;
  height: 320px;
  overflow-y: auto;
  scroll-behavior: smooth;
}

/* Scrollbar */
.terminal::-webkit-scrollbar { width: 6px; }
.terminal::-webkit-scrollbar-track { background: transparent; }
.terminal::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

.log-line { display: block; }
.log-msg { display: block; }
.log-msg.info    { color: #8899cc; }
.log-msg.success { color: var(--green); }
.log-msg.warn    { color: var(--amber); }
.log-msg.error   { color: var(--red); }
.log-msg.dim     { color: var(--muted); }

/* progress bar */
.progress-wrap { margin-top: 14px; }
.progress-meta {
  display: flex; justify-content: space-between;
  font-family: 'Space Mono', monospace; font-size: .68rem;
  color: var(--muted); margin-bottom: 6px;
}
.progress-track {
  height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: var(--green); border-radius: 2px;
  width: 0%; transition: width .4s ease;
}
.progress-indeterminate .progress-fill {
  animation: progress-slide 1.4s ease infinite;
  width: 40% !important;
}
@keyframes progress-slide {
  0%   { transform: translateX(-100%); }
  100% { transform: translateX(300%); }
}

/* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#results-card { display: none; }
#results-card.show { display: block; }

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}
@media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr 1fr; } }

.stat {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 10px;
  text-align: center;
}
.stat-n {
  font-family: 'Space Mono', monospace;
  font-size: 1.8rem; font-weight: 700;
  color: var(--green); line-height: 1;
}
.stat-l { font-size: .68rem; color: var(--muted); margin-top: 4px; text-transform: uppercase; letter-spacing: .4px; }

.dl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
@media (max-width: 500px) { .dl-grid { grid-template-columns: 1fr; } }

.dl-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 15px; border-radius: var(--r);
  font-family: 'Space Mono', monospace; font-size: .75rem; font-weight: 700;
  letter-spacing: .8px; text-transform: uppercase; text-decoration: none;
  cursor: pointer; transition: all .2s; border: 1.5px solid;
}
.dl-owl  { border-color: var(--green);  color: var(--green);  background: rgba(79,255,176,.05); }
.dl-owl:hover  { background: rgba(79,255,176,.12); box-shadow: 0 4px 16px rgba(79,255,176,.15); }
.dl-json { border-color: var(--blue);   color: var(--blue);   background: rgba(77,184,255,.05); }
.dl-json:hover { background: rgba(77,184,255,.12); box-shadow: 0 4px 16px rgba(77,184,255,.15); }

/* â”€â”€ Rec list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rec-heading {
  font-family: 'Space Mono', monospace;
  font-size: .65rem; letter-spacing: 1.2px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 10px;
}
.rec-list { list-style: none; display: flex; flex-direction: column; gap: 7px; }
.rec-item {
  background: var(--bg); border: 1px solid var(--border);
  border-left: 3px solid var(--blue);
  border-radius: 7px; padding: 10px 14px;
}
.rec-name { font-family: 'Space Mono', monospace; font-size: .75rem; color: var(--blue); }
.rec-meta { font-size: .7rem; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Error alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert {
  display: none; padding: 14px 16px;
  border-radius: 8px; font-size: .85rem; margin-top: 14px;
}
.alert.show { display: block; }
.alert-error { background: rgba(255,95,95,.08); border: 1px solid rgba(255,95,95,.3); color: #ff8f8f; }
</style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <header>
    <div class="wordmark">
      <div class="wordmark-icon">
        <svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="3.5" r="2.5" fill="#0a0c10"/>
          <circle cx="3.5" cy="17" r="2.5" fill="#0a0c10"/>
          <circle cx="18.5" cy="17" r="2.5" fill="#0a0c10"/>
          <line x1="11" y1="6" x2="3.5" y2="14.5" stroke="#0a0c10" stroke-width="1.5"/>
          <line x1="11" y1="6" x2="18.5" y2="14.5" stroke="#0a0c10" stroke-width="1.5"/>
          <line x1="3.5" y1="17" x2="18.5" y2="17" stroke="#0a0c10" stroke-width="1.5"/>
        </svg>
      </div>
      <span class="wordmark-text">OntologyUpdater</span>
    </div>
    <h1>Populate your OWL ontology<br/>from CSV data</h1>
    <p class="tagline">Upload your files â€” GPT maps each row to your ontology<br/>and returns a ready-to-use enriched .owl file</p>
  </header>

  <!-- â‘  Files -->
  <div class="card">
    <div class="card-label">Step 1 â€” Upload files</div>
    <div class="drop-grid">

      <div class="drop" id="csv-zone">
        <input type="file" id="csv-input" accept=".csv" />
        <span class="drop-emoji">ğŸ“Š</span>
        <div class="drop-title">CSV Data</div>
        <div class="drop-sub">Drop or click Â· .csv</div>
        <div class="drop-filename" id="csv-fname"></div>
      </div>

      <div class="drop" id="owl-zone">
        <input type="file" id="owl-input" accept=".owl" />
        <span class="drop-emoji">ğŸ•¸ï¸</span>
        <div class="drop-title">OWL Ontology</div>
        <div class="drop-sub">Drop or click Â· .owl</div>
        <div class="drop-filename" id="owl-fname"></div>
      </div>

    </div>
  </div>

  <!-- â‘¡ Options -->
  <div class="card">
    <div class="card-label">Step 2 â€” Options</div>

    <div class="option-row">
      <div class="option-info">
        <div class="option-name">Generate Recommendations</div>
        <div class="option-desc">After processing, ask GPT to suggest new classes or properties for unmapped columns</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="opt-rec" checked />
        <span class="switch-track"></span>
      </label>
    </div>

  </div>

  <!-- â‘¢ Run -->
  <div class="card">
    <div class="card-label">Step 3 â€” Process</div>
    <button class="run-btn" id="run-btn" disabled>Run Ontology Update</button>
    <div class="alert alert-error" id="error-box"></div>
  </div>

  <!-- Live log -->
  <div class="card" id="log-card">
    <div class="card-label">Processing log</div>
    <div class="terminal" id="terminal"></div>
    <div class="progress-wrap">
      <div class="progress-meta">
        <span id="prog-label">Waitingâ€¦</span>
      </div>
      <div class="progress-track" id="prog-track">
        <div class="progress-fill" id="prog-fill"></div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="card" id="results-card">
    <div class="card-label">Results</div>
    <div class="stats-grid" id="stats-grid"></div>
    <div class="dl-grid">
      <a class="dl-btn dl-owl" id="dl-owl" href="#" download>
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M7 1v8M4 6l3 3 3-3M2 11h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Download updated .owl
      </a>
      <a class="dl-btn dl-json" id="dl-json" href="#" download>
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M7 1v8M4 6l3 3 3-3M2 11h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Download recommendations
      </a>
    </div>
    <div id="rec-section"></div>
  </div>

</div><!-- /page -->

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Set this to your Railway backend URL â€” no trailing slash
const BACKEND_URL = "https://ontologyupdater-production.up.railway.app";
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let csvFile = null, owlFile = null;
let owlFilename = "ontology_updated.owl";

// â”€â”€ Drop zones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDrop(zoneId, inputId, ext) {
  const zone  = document.getElementById(zoneId);
  const input = document.getElementById(inputId);
  const fname = document.getElementById(`${ext}-fname`);

  function set(f) {
    if (!f) return;
    if (ext === 'csv') csvFile = f; else owlFile = f;
    zone.classList.add('filled');
    fname.textContent = f.name;
    checkReady();
  }

  input.addEventListener('change', e => set(e.target.files[0]));
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('over'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('over');
    set(e.dataTransfer.files[0]);
  });
}

setupDrop('csv-zone', 'csv-input', 'csv');
setupDrop('owl-zone', 'owl-input', 'owl');

// â”€â”€ Ready check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const runBtn = document.getElementById('run-btn');
function checkReady() { runBtn.disabled = !(csvFile && owlFile); }

// â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const terminal = document.getElementById('terminal');

function addLog(line, forceLevel) {
  // Auto-detect level from content
  let level = forceLevel || 'info';
  if (!forceLevel) {
    if (/âœ“|âœ¦|Done|Success|created|loaded|serialized|generated/i.test(line)) level = 'success';
    else if (/âš |warning|skipped|unmapped|\?/i.test(line)) level = 'warn';
    else if (/âœ—|error|failed|fatal/i.test(line)) level = 'error';
    else if (/={3,}|-{3,}|SUMMARY|PROCESS/i.test(line)) level = 'dim';
  }
  const div = document.createElement('div');
  div.className = 'log-line';
  div.innerHTML = `<span class="log-msg ${level}">${escHtml(line)}</span>`;
  terminal.appendChild(div);
  terminal.scrollTop = terminal.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
runBtn.addEventListener('click', async () => {
  const errorBox = document.getElementById('error-box');
  errorBox.classList.remove('show');
  document.getElementById('results-card').classList.remove('show');
  terminal.innerHTML = '';

  // Show log card with waiting hint
  document.getElementById('log-card').classList.add('show');
  document.getElementById('log-card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  addLog('Sending files to backend â€” processing may take a whileâ€¦');

  runBtn.disabled = true;
  runBtn.classList.add('busy');
  document.getElementById('prog-label').textContent = 'Processingâ€¦';
  document.getElementById('prog-fill').style.width = '0%';
  document.getElementById('prog-track').classList.add('progress-indeterminate');

  const fd = new FormData();
  fd.append('csv_file', csvFile);
  fd.append('owl_file', owlFile);
  fd.append('enable_recommendations', document.getElementById('opt-rec').checked ? 'true' : 'false');

  try {
    const resp = await fetch(`${BACKEND_URL}/update-ontology`, { method: 'POST', body: fd });
    const data = await resp.json();

    if (!resp.ok || !data.success) {
      throw new Error(data.detail || data.message || `HTTP ${resp.status}`);
    }

    // Render backend print logs
    terminal.innerHTML = '';
    (data.logs || []).forEach(line => addLog(line));

    owlFilename = data.owl_filename || owlFilename;
    renderResults(data);

  } catch (err) {
    errorBox.textContent = `Error: ${err.message}`;
    errorBox.classList.add('show');
    addLog(`Error: ${err.message}`, 'error');
  } finally {
    runBtn.classList.remove('busy');
    runBtn.disabled = false;
    document.getElementById('prog-label').textContent = 'Done';
    document.getElementById('prog-track').classList.remove('progress-indeterminate');
    document.getElementById('prog-fill').style.width = '100%';
  }
});

// â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults({ stats, recommendations, owl_file_b64 }) {
  // Stats grid
  const grid = document.getElementById('stats-grid');
  const items = [
    ['total_rows',            'Total Rows'],
    ['successful',            'Processed'],
    ['new_cabai',             'New Cabai'],
    ['total_properties_added','Props Added'],
    ['triples_added',         'Triples Added'],
    ['new_properties_created','New Props'],
  ];
  grid.innerHTML = items.map(([k, l]) =>
    `<div class="stat"><div class="stat-n">${stats[k] ?? 0}</div><div class="stat-l">${l}</div></div>`
  ).join('');

  // OWL download
  const owlBytes = atob(owl_file_b64);
  const owlArr = new Uint8Array(owlBytes.length);
  for (let i = 0; i < owlBytes.length; i++) owlArr[i] = owlBytes.charCodeAt(i);
  const owlBlob = new Blob([owlArr], { type: 'application/rdf+xml' });
  const dlOwl = document.getElementById('dl-owl');
  dlOwl.href = URL.createObjectURL(owlBlob);
  dlOwl.download = owlFilename;

  // JSON download
  const recJson = JSON.stringify(recommendations, null, 2);
  const recBlob = new Blob([recJson], { type: 'application/json' });
  const dlJson = document.getElementById('dl-json');
  dlJson.href = URL.createObjectURL(recBlob);
  dlJson.download = 'ontology_recommendations.json';

  // Recommendations preview
  const recSection = document.getElementById('rec-section');
  const all = [
    ...Object.entries(recommendations.new_classes       || {}).map(([k,v]) => ({ name: k, type: 'New Class',           conf: v.confidence })),
    ...Object.entries(recommendations.new_properties    || {}).map(([k,v]) => ({ name: k, type: 'New Datatype Property',conf: v.confidence })),
    ...Object.entries(recommendations.new_object_properties || {}).map(([k,v]) => ({ name: k, type: 'New Object Property', conf: v.confidence })),
  ].sort((a,b) => b.conf - a.conf).slice(0, 10);

  const total = recommendations.summary?.total_recommendations ?? 0;

  if (all.length > 0) {
    recSection.innerHTML = `
      <div class="rec-heading">Ontology recommendations (${total} total)</div>
      <ul class="rec-list">
        ${all.map(r => `
          <li class="rec-item">
            <div class="rec-name">${r.name}</div>
            <div class="rec-meta">${r.type} &middot; Confidence ${(r.conf * 100).toFixed(0)}%</div>
          </li>
        `).join('')}
      </ul>`;
  } else {
    recSection.innerHTML = `<div style="font-size:.85rem;color:var(--green)">âœ“ No new recommendations â€” all columns mapped to existing ontology properties.</div>`;
  }

  document.getElementById('results-card').classList.add('show');
  document.getElementById('results-card').scrollIntoView({ behavior: 'smooth' });
}
</script>
</body>
</html>
